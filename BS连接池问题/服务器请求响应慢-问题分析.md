#### 问题

核心服务有某一时间出现大量请求响应慢

#### 分析

1、使用jstack命令将堆栈信息输出分析。

jstack110_11-24.txt、jstack130_11-24.txt、main-jstack110_10-49.txt

2、查看堆栈信息发现tomcat线程池大多都是处于WAITING阻塞状态，具体堆栈信息是去查询数据库连接阻塞

![1616736135764](C:\Users\Jiyang.Zheng\AppData\Roaming\Typora\typora-user-images\1616736135764.png)

3、还有一些线程处于RUNNABLE状态，堆栈信息中有查询数据库操作。

![1616736295499](C:\Users\Jiyang.Zheng\AppData\Roaming\Typora\typora-user-images\1616736295499.png)

3、这个时候觉得是数据库连接的出现问题，就再次取另外一台线程堆栈看看是否有这种获取数据库连接阻塞被唤醒状态，发现另外台机器也是出现相同的问题

#### 定位

出现连接不够用的现象可以断定两点：
1、可能是数据库连接不够用，现象是出现缓存穿透都打到了数据库
2、对数据库有一个慢查询，所有的请求查询数据库都被阻塞。当一个请求慢需要验证线程如果处于RUNNABLE状态，查看线程堆栈是否有查询数据库操作，如果有数据库查询的的话确认是不是慢查询导致，可以隔几秒将堆栈信息打印，验证同一个线程是否在不同时间的堆栈都是处于RUNNABLE状态，如果有的话可以确定出现了慢查询。

此时就可以确定是有数据库慢查询导致服务器响应慢

